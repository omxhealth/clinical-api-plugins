<meta charset="utf-8">
<title>medication-search demo</title>
<script src="/js/drugbank-ui.min.js"></script>
<link rel="stylesheet" href="/css/app.css">

<div class="app">
  <% if logged_in? %>
    <b>You're "logged in"</b>
    Click <a href="/logout">here</a> to destroy the logged in session.
  <% else %>
    <b>You aren't logged in</b>
    Click <a href="/login/345">here</a> to do a sample login as user 345!
  <% end %>

  <br/><br/>

  <form action="/" method="POST" id="sample-form">
    <db-ddi-viewer
      name="ddi"
      refresh-jwt="/protected-refresh-jwt"
      shared-jwt="true"
    ></db-ddi-viewer>
    <br/><br/>
    <div class='form-row'>
      <label>Medications:</label>
    </div>
    <div class='form-row'>
      <db-medication-search
        refresh-jwt="/protected-refresh-jwt"
        name="medications[0]"
        value="<%= @medications['0'] %>"
        shared-jwt="true"
      ></db-medication-search>
    </div>
    <div class='form-row'>
      <db-medication-search
        refresh-jwt="/protected-refresh-jwt"
        name="medications[1]"
        value="<%= @medications['1'] %>"
        shared-jwt="true"
      ></db-medication-search>
    </div>
    <div class='form-row'>
      <db-medication-search
        refresh-jwt="/protected-refresh-jwt"
        name="medications[2]"
        value="<%= @medications['2'] %>"
        shared-jwt="true"
      ></db-medication-search>
    </div>
    <div class='form-row'>
      <db-medication-search
        refresh-jwt="/protected-refresh-jwt"
        name="medications[3]"
        value="<%= @medications['3'] %>"
        shared-jwt="true"
      ></db-medication-search>
    </div>
  </form>

  <div id="message">
    <% if @medications && !@medications.empty? %>
      Hello <%= (@name && !@name.empty?) ? @name : 'Anonymous Person' %>, you chose:
      <ul>
        <% @medications.values.each do |dbpcid| %>
          <li><%= dbpcid %></li>
        <% end %>
      </ul>
    <% end %>
  <div>
</div>

<script>
    const ddiViewer = document.getElementsByName('ddi')[0]
    const medicationSearches = [...document.getElementsByTagName('db-medication-search')]

    let medications = {}

    medicationSearches.forEach(search => {
        const name = search.getAttribute('name')
        search.addEventListener("medication-changed", function(e) {
            medications[name] = e.detail.drugbank_pcid
            const dbpcIds = Object.values(medications)
            ddiViewer.setAttribute('drugbank-pcid', dbpcIds.join(','))
        })
    });
</script>

<style>
</style>